# database.py
import sqlite3
from datetime import datetime
from typing import List

DB_PATH = "database.db"

def get_conn():
    conn = sqlite3.connect(DB_PATH)
    conn.row_factory = sqlite3.Row
    return conn

# === ÐŸÐ¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ð¸ ===
def add_user(user_id: int, first_name: str, username: str = None):
    conn = get_conn()
    try:
        conn.execute(
            "INSERT OR IGNORE INTO users (id, username, first_name) VALUES (?, ?, ?)",
            (user_id, username, first_name)
        )
        conn.commit()
    finally:
        conn.close()

def get_user(user_id: int):
    conn = get_conn()
    try:
        cur = conn.cursor()
        cur.execute("SELECT * FROM users WHERE id = ?", (user_id,))
        return cur.fetchone()
    finally:
        conn.close()

# === ÐÐ°ÑÑ‚Ñ€Ð¾ÐµÐ½Ð¸Ðµ ===
def has_mood_today(user_id: int) -> bool:
    today = datetime.now().strftime("%Y-%m-%d")
    conn = get_conn()
    try:
        cur = conn.cursor()
        cur.execute("SELECT 1 FROM moods WHERE user_id = ? AND date = ?", (user_id, today))
        return cur.fetchone() is not None
    finally:
        conn.close()

def save_mood(user_id: int, mood: str, note: str = ""):
    today = datetime.now().strftime("%Y-%m-%d")
    conn = get_conn()
    try:
        conn.execute(
            "INSERT OR REPLACE INTO moods (user_id, date, mood, note) VALUES (?, ?, ?, ?)",
            (user_id, today, mood, note)
        )
        add_points(user_id, 10)
        conn.commit()
    finally:
        conn.close()

# === Ð¢Ñ€ÐµÐºÐµÑ€Ñ‹ (Ð²Ð¾Ð´Ð°, ÑÐ¾Ð½) ===
def update_daily_trackers(user_id: int, water_liters: float = None, sleep_hours: int = None):
    today = datetime.now().strftime("%Y-%m-%d")
    conn = get_conn()
    try:
        conn.execute(
            """INSERT INTO trackers (user_id, date, water, sleep)
               VALUES (?, ?, ?, ?)
               ON CONFLICT(user_id, date) DO UPDATE SET
                   water = COALESCE(excluded.water, water),
                   sleep = COALESCE(excluded.sleep, sleep)""",
            (user_id, today, water_liters, sleep_hours)
        )
        conn.commit()
    finally:
        conn.close()

def get_today_trackers(user_id: int) -> sqlite3.Row:
    today = datetime.now().strftime("%Y-%m-%d")
    conn = get_conn()
    try:
        cur = conn.cursor()
        cur.execute("SELECT water, sleep FROM trackers WHERE user_id = ? AND date = ?", (user_id, today))
        return cur.fetchone()
    finally:
        conn.close()

# === Ð§ÐµÐ»Ð»ÐµÐ½Ð´Ð¶Ð¸ ===
def set_daily_challenge(user_id: int, text: str):
    conn = get_conn()
    try:
        conn.execute("DELETE FROM challenges WHERE user_id = ? AND completed = 0", (user_id,))
        conn.execute(
            "INSERT INTO challenges (user_id, challenge_name, start_date) VALUES (?, ?, date('now'))",
            (user_id, text)
        )
        conn.commit()
    finally:
        conn.close()

def get_today_challenge(user_id: int):
    conn = get_conn()
    try:
        cur = conn.cursor()
        cur.execute(
            "SELECT challenge_name FROM challenges WHERE user_id = ? AND completed = 0",
            (user_id,)
        )
        row = cur.fetchone()
        return row["challenge_name"] if row else None
    finally:
        conn.close()

def complete_today_challenge(user_id: int):
    conn = get_conn()
    try:
        conn.execute("UPDATE challenges SET completed = 1 WHERE user_id = ? AND completed = 0", (user_id,))
        add_points(user_id, 50)
        conn.commit()
    finally:
        conn.close()

# === ÐžÑ‡ÐºÐ¸ Ð¸ Ð°Ñ‡Ð¸Ð²ÐºÐ¸ ===
def add_points(user_id: int, points: int):
    conn = get_conn()
    try:
        conn.execute(
            """INSERT INTO user_points (user_id, points) VALUES (?, ?)
               ON CONFLICT(user_id) DO UPDATE SET points = points + ?""",
            (user_id, points, points)
        )
        conn.commit()
    finally:
        conn.close()
    check_achievements(user_id)

def get_points(user_id: int) -> int:
    conn = get_conn()
    try:
        cur = conn.cursor()
        cur.execute("SELECT points FROM user_points WHERE user_id = ?", (user_id,))
        row = cur.fetchone()
        return row["points"] if row else 0
    finally:
        conn.close()

def unlock_achievement(user_id: int, title: str, desc: str = "", emoji: str = "ðŸ†"):
    conn = get_conn()
    try:
        conn.execute(
            """INSERT OR IGNORE INTO achievements (user_id, title, description, emoji)
               VALUES (?, ?, ?, ?)""",
            (user_id, title, desc, emoji)
        )
        conn.commit()
    finally:
        conn.close()

def _count_rows(query: str, params: tuple) -> int:
    conn = get_conn()
    try:
        cur = conn.execute(query, params)
        rows = cur.fetchall()
        return len(rows)
    finally:
        conn.close()

def _has_achievement(user_id: int, title: str) -> bool:
    conn = get_conn()
    try:
        cur = conn.execute(
            "SELECT 1 FROM achievements WHERE user_id = ? AND title = ?",
            (user_id, title)
        )
        return cur.fetchone() is not None
    finally:
        conn.close()

def check_achievements(user_id: int):
    points = get_points(user_id)
    mood_count = _count_rows("SELECT date FROM moods WHERE user_id = ?", (user_id,))
    water_count = _count_rows("SELECT water FROM trackers WHERE user_id = ? AND water > 0", (user_id,))
    sleep_count = _count_rows("SELECT sleep FROM trackers WHERE user_id = ? AND sleep > 0", (user_id,))

    if points >= 100 and not _has_achievement(user_id, "100 Ð¾Ñ‡ÐºÐ¾Ð²"):
        unlock_achievement(user_id, "100 Ð¾Ñ‡ÐºÐ¾Ð²", "ÐÐ°ÑÑ‚Ð¾ÑÑ‰Ð¸Ð¹ Ð¼Ð°ÑÑ‚ÐµÑ€ Ð·Ð°Ð±Ð¾Ñ‚Ñ‹!", "â­")

    if mood_count >= 7 and not _has_achievement(user_id, "ÐÐµÐ´ÐµÐ»Ñ Ð½Ð°ÑÑ‚Ñ€Ð¾ÐµÐ½Ð¸Ñ"):
        unlock_achievement(user_id, "ÐÐµÐ´ÐµÐ»Ñ Ð½Ð°ÑÑ‚Ñ€Ð¾ÐµÐ½Ð¸Ñ", "7 Ð´Ð½ÐµÐ¹ Ð¿Ð¾Ð´Ñ€ÑÐ´ Ð¾Ñ‚Ð¼ÐµÑ‡Ð°Ð» Ð½Ð°ÑÑ‚Ñ€Ð¾ÐµÐ½Ð¸Ðµ", "ðŸ“…")

    if water_count >= 10 and not _has_achievement(user_id, "Ð“Ð¸Ð´Ñ€Ð°Ñ‚Ð°Ñ†Ð¸Ñ"):
        unlock_achievement(user_id, "Ð“Ð¸Ð´Ñ€Ð°Ñ‚Ð°Ñ†Ð¸Ñ", "10 Ñ€Ð°Ð· Ð·Ð°Ð¿Ð¸ÑÐ°Ð» Ð²Ð¾Ð´Ñƒ", "ðŸ’§")

    if sleep_count >= 10 and not _has_achievement(user_id, "Ð¡Ð¾Ð½ â€” ÑÐ¸Ð»Ð°"):
        unlock_achievement(user_id, "Ð¡Ð¾Ð½ â€” ÑÐ¸Ð»Ð°", "10 Ñ€Ð°Ð· Ð·Ð°Ð¿Ð¸ÑÐ°Ð» ÑÐ¾Ð½", "ðŸ˜´")

def get_achievements(user_id: int) -> List[sqlite3.Row]:
    conn = get_conn()
    try:
        cur = conn.cursor()
        cur.execute("SELECT title, description, emoji FROM achievements WHERE user_id = ?", (user_id,))
        return cur.fetchall()
    finally:
        conn.close()
